

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Optimizing FFT Performance for PSF Computations with FFTW &mdash; webbpsf v0.8.0</title>
  

  
  
    <link rel="shortcut icon" href="_static/astropy_logo.ico"/>
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/stsci.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="_static/stsci.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Appendix: Available Optical Path Difference (OPD) files" href="available_opds.html" />
    <link rel="prev" title="Sampling Requirements for Numerical Accuracy" href="sampling.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          
            <a href="index.html" class="icon icon-home"> webbpsf
            
            <img src="_static/stsci_pri_combo_mark_white.png" class="logo" />
          </a>

          
            
            
              <div class="version">
                0.8.0
              </div>
            
          
          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
  
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Requirements &amp; Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="relnotes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Using WebbPSF via the Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="jwst.html">JWST Instrument Model Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="wfirst.html">WFIRST Instrument Model Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="psf_grids.html">Using PSF Grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="more_examples.html">More Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="poppy.html">Overview of POPPY (Physical Optics Propagation in Python)</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="api_reference.html">Detailed API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="help.html">Diagnostics &amp; Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="sampling.html">Sampling Requirements for Numerical Accuracy</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Optimizing FFT Performance for PSF Computations with FFTW</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#planning-in-fftw3">Planning in FFTW3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-comparison-of-different-fft-methods">A comparison of different FFT methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-test-comparing-all-four-planning-methods">A test comparing all four planning methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-comparison-of-estimate-and-measure-for-different-sizes">A comparison of ‘estimate’ and ‘measure’ for different sizes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#caching-of-plans-means-that-irunning-the-same-script-a-second-time-is-much-faster">Caching of plans means that irunning the same script a second time is much faster</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-payoff-speed-improvements-in-poppy">The Payoff: Speed improvements in POPPY</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="available_opds.html">Appendix: Available Optical Path Difference (OPD) files</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">Appendix: Instrument Property References</a></li>
<li class="toctree-l1"><a class="reference internal" href="gui.html">(Deprecated)  Graphical User Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="release.html">Developer Notes: Releasing a new version of WebbPSF</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">webbpsf</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Optimizing FFT Performance for PSF Computations with FFTW</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/fft_optimization.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="optimizing-fft-performance-for-psf-computations-with-fftw">
<h1>Optimizing FFT Performance for PSF Computations with FFTW<a class="headerlink" href="#optimizing-fft-performance-for-psf-computations-with-fftw" title="Permalink to this headline">¶</a></h1>
<p>Optimizing numerical performance of FFTs is a very complicated subject. Just using the FFTW library is no guarantee of optimal performance; you need to know how to configure it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following tests were performed using the older PyFFTW3 package, and have not yet been updated for the newer pyFFTW package. However, performance considerations are expected to be fairly similar for both packages since the underlying FFTW library is the same.</p>
<p>See discussion and test results at <a class="reference external" href="https://github.com/spacetelescope/webbpsf/issues/10">https://github.com/spacetelescope/webbpsf/issues/10</a></p>
</div>
<p>This is probably fairly sensitive to hardware details. The following benchmarks were performed on a Mac Pro, dual quad-core 2.66 GHz Xeon, 12 GB RAM.</p>
<blockquote>
<div><ul class="simple">
<li><p>Unlike many of the array operations in <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/index.html#module-numpy" title="(in NumPy v1.17)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy</span></code></a>, the <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/routines.fft.html#module-numpy.fft" title="(in NumPy v1.17)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">fft</span></code></a> operation is not threaded for execution across multiple processors. It is thus slow and inefficient.</p></li>
<li><p>Numpy and Scipy no longer include FFTW, but luckily there is an independently maintained pyfftw3 module.  See <a class="reference external" href="https://launchpad.net/pyfftw/">https://launchpad.net/pyfftw/</a></p></li>
<li><p>Using pyfftw3 can result in a 3-4x speedup for moderately large arrays.  However, there are two significant gotchas to be aware of:</p></li>
</ul>
<blockquote>
<div><ol class="arabic simple">
<li><p>the pyfftw3.Plan() function has a default parameter of nthreads=1. You have to
explicitly tell it to use multiple threads if you wish to reap the
rewards of multiple processors.  By default with nthreads=1 it is in fact a
bit slower than numpy.fft!</p></li>
<li><p>The FFTW3 documentation asserts that greater speed can be achieved by using
arrays which are aligned in memory to 16-byte boundaries. There is a
fftw3.create_aligned_array() function that created numpy arrays which have
this property. While I expected using this would make the transforms faster,
in fact I see significantly better performance when using unaligned arrays.
(The speed difference becomes larger as array size increases, up to 2x!)
This is unexpected and not understood, so it may vary by machine and I
suggest one ought to test this on different machines to see if it is reliable.</p></li>
</ol>
</div></blockquote>
</div></blockquote>
<div class="section" id="planning-in-fftw3">
<h2>Planning in FFTW3<a class="headerlink" href="#planning-in-fftw3" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Performing plans can take a <em>long</em> time, especially if you select exhaustive or patient modes:</p></li>
<li><p>The default option is ‘estimate’ which turns out to be really a poor choice.</p></li>
<li><p>It appears that you can get most of the planning benefit from using the ‘measure’ option.</p></li>
<li><p>Curiously, the really time-consuming planning only appears to take place if you do use aligned arrays.
If you use regular unaligned arrays, then a very abbreviated planning set is performed, and yet you still
appear to reap most of the benefits of</p></li>
</ul>
</div>
<div class="section" id="a-comparison-of-different-fft-methods">
<h2>A comparison of different FFT methods<a class="headerlink" href="#a-comparison-of-different-fft-methods" title="Permalink to this headline">¶</a></h2>
<p>This test involves, in each iteration, allocating a new numpy array filled
with random values, passing it to a function, FFTing it, and then returning the
result. Thus it is a fairly realistic test but takes longer per iteration than some of the
other tests presented below on this page. This is noted here in way of explanation for why
there are discrepant values for how long an optimized FFT of a given size takes.</p>
<p>Test results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Doing</span> <span class="nb">complex</span> <span class="n">FFT</span> <span class="k">with</span> <span class="n">array</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="n">x</span> <span class="mi">1024</span>
   <span class="k">for</span>         <span class="n">numpy</span> <span class="n">fft</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.094331</span> <span class="n">s</span>
   <span class="k">for</span>             <span class="n">fftw3</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.073848</span> <span class="n">s</span>
   <span class="k">for</span>    <span class="n">fftw3</span> <span class="n">threaded</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.063143</span> <span class="n">s</span>
   <span class="k">for</span> <span class="n">fftw3</span> <span class="n">thr</span> <span class="n">noalign</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.020411</span> <span class="n">s</span>
   <span class="k">for</span> <span class="n">fftw3</span> <span class="n">thr</span> <span class="n">na</span> <span class="n">inplace</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.017340</span> <span class="n">s</span>
<span class="n">Doing</span> <span class="nb">complex</span> <span class="n">FFT</span> <span class="k">with</span> <span class="n">array</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">2048</span> <span class="n">x</span> <span class="mi">2048</span>
   <span class="k">for</span>         <span class="n">numpy</span> <span class="n">fft</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.390593</span> <span class="n">s</span>
   <span class="k">for</span>             <span class="n">fftw3</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.304292</span> <span class="n">s</span>
   <span class="k">for</span>    <span class="n">fftw3</span> <span class="n">threaded</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.224193</span> <span class="n">s</span>
   <span class="k">for</span> <span class="n">fftw3</span> <span class="n">thr</span> <span class="n">noalign</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.061629</span> <span class="n">s</span>
   <span class="k">for</span> <span class="n">fftw3</span> <span class="n">thr</span> <span class="n">na</span> <span class="n">inplace</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.047997</span> <span class="n">s</span>
<span class="n">Doing</span> <span class="nb">complex</span> <span class="n">FFT</span> <span class="k">with</span> <span class="n">array</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="n">x</span> <span class="mi">4096</span>
   <span class="k">for</span>         <span class="n">numpy</span> <span class="n">fft</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">2.190670</span> <span class="n">s</span>
   <span class="k">for</span>             <span class="n">fftw3</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">1.911555</span> <span class="n">s</span>
   <span class="k">for</span>    <span class="n">fftw3</span> <span class="n">threaded</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">1.414653</span> <span class="n">s</span>
   <span class="k">for</span> <span class="n">fftw3</span> <span class="n">thr</span> <span class="n">noalign</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.332999</span> <span class="n">s</span>
   <span class="k">for</span> <span class="n">fftw3</span> <span class="n">thr</span> <span class="n">na</span> <span class="n">inplace</span><span class="p">,</span> <span class="n">elapsed</span> <span class="n">time</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">0.293531</span> <span class="n">s</span>
</pre></div>
</div>
<p>Conclusions: It appears that the most efficient algorithm is a non-aligned in-place FFT.  Therefore, this is the algorithm adopted into POPPY.</p>
<p>In this case, it makes sense that avoiding the alignment is beneficial, since it avoids a memory copy of the
entire array (from regular python unaligned into the special aligned array).
Another set of tests (results not shown here) indicated that there is no gain in performance from FFTing from an unaligned input array to an aligned output array.</p>
</div>
<div class="section" id="a-test-comparing-all-four-planning-methods">
<h2>A test comparing all four planning methods<a class="headerlink" href="#a-test-comparing-all-four-planning-methods" title="Permalink to this headline">¶</a></h2>
<p>This test involves creating one single input array (specifically, a large circle in the central half of the array)
and then repeatedly FFTing that same array. Thus it is pretty much the best possible case and the speeds are very fast.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">For</span> <span class="n">arrays</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">512</span><span class="n">x512</span>
<span class="n">Building</span> <span class="nb">input</span> <span class="n">circular</span> <span class="n">aperture</span>
        <span class="n">that</span> <span class="n">took</span> <span class="mf">0.024070</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">estimate</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.041177</span>        <span class="mf">0.005638</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.017639</span>        <span class="mf">0.017181</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">measure</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.328468</span>        <span class="mf">0.006960</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.001991</span>        <span class="mf">0.002741</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">patient</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">39.816985</span>       <span class="mf">0.020944</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.002081</span>        <span class="mf">0.002475</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">exhaustive</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">478.421909</span>      <span class="mf">0.090302</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.004974</span>        <span class="mf">0.002467</span> <span class="n">s</span>
</pre></div>
</div>
</div>
<div class="section" id="a-comparison-of-estimate-and-measure-for-different-sizes">
<h2>A comparison of ‘estimate’ and ‘measure’ for different sizes<a class="headerlink" href="#a-comparison-of-estimate-and-measure-for-different-sizes" title="Permalink to this headline">¶</a></h2>
<p>This test involves creating one single input array (specifically, a large circle in the central half of the array)
and then repeatedly FFTing that same array. Thus it is pretty much the best possible case and the speeds are very fast.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">For</span> <span class="n">arrays</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">1024</span><span class="n">x1024</span>
<span class="n">Building</span> <span class="nb">input</span> <span class="n">circular</span> <span class="n">aperture</span>
        <span class="n">that</span> <span class="n">took</span> <span class="mf">0.120378</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">estimate</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.006557</span>        <span class="mf">0.014652</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.041282</span>        <span class="mf">0.041586</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">measure</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">1.434870</span>        <span class="mf">0.015797</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.008814</span>        <span class="mf">0.011852</span> <span class="n">s</span>

<span class="n">For</span> <span class="n">arrays</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">2048</span><span class="n">x2048</span>
<span class="n">Building</span> <span class="nb">input</span> <span class="n">circular</span> <span class="n">aperture</span>
        <span class="n">that</span> <span class="n">took</span> <span class="mf">0.469819</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">estimate</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.006753</span>        <span class="mf">0.032270</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.098976</span>        <span class="mf">0.098925</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">measure</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">5.347839</span>        <span class="mf">0.033213</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.028528</span>        <span class="mf">0.047729</span> <span class="n">s</span>

<span class="n">For</span> <span class="n">arrays</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">4096</span><span class="n">x4096</span>
<span class="n">Building</span> <span class="nb">input</span> <span class="n">circular</span> <span class="n">aperture</span>
        <span class="n">that</span> <span class="n">took</span> <span class="mf">2.078152</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">estimate</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.007102</span>        <span class="mf">0.056571</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.395048</span>        <span class="mf">0.326832</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">measure</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">17.890278</span>       <span class="mf">0.057363</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.126414</span>        <span class="mf">0.133602</span> <span class="n">s</span>

<span class="n">For</span> <span class="n">arrays</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">8192</span><span class="n">x8192</span>
<span class="n">Building</span> <span class="nb">input</span> <span class="n">circular</span> <span class="n">aperture</span>
        <span class="n">that</span> <span class="n">took</span> <span class="mf">93.043509</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">estimate</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.245359</span>        <span class="mf">0.425931</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">2.800093</span>        <span class="mf">1.426851</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">measure</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">41.203768</span>       <span class="mf">0.235688</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.599916</span>        <span class="mf">0.526022</span> <span class="n">s</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-of-plans-means-that-irunning-the-same-script-a-second-time-is-much-faster">
<h2>Caching of plans means that irunning the same script a second time is much faster<a class="headerlink" href="#caching-of-plans-means-that-irunning-the-same-script-a-second-time-is-much-faster" title="Permalink to this headline">¶</a></h2>
<p>Immediately after executing the above, I ran the same script again. Now the planning times all become essentially negligible.</p>
<p>Oddly, the exection time for the largest array gets longer. I suspect this has something to do with memory or system load.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">For</span> <span class="n">arrays</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">1024</span><span class="n">x1024</span>
<span class="n">Building</span> <span class="nb">input</span> <span class="n">circular</span> <span class="n">aperture</span>
        <span class="n">that</span> <span class="n">took</span> <span class="mf">0.115704</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">estimate</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.005147</span>        <span class="mf">0.015813</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.006883</span>        <span class="mf">0.011428</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">measure</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.009078</span>        <span class="mf">0.012562</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.007057</span>        <span class="mf">0.010706</span> <span class="n">s</span>

<span class="n">For</span> <span class="n">arrays</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">2048</span><span class="n">x2048</span>
<span class="n">Building</span> <span class="nb">input</span> <span class="n">circular</span> <span class="n">aperture</span>
        <span class="n">that</span> <span class="n">took</span> <span class="mf">0.421966</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">estimate</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.004888</span>        <span class="mf">0.032564</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.026869</span>        <span class="mf">0.043273</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">measure</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.019813</span>        <span class="mf">0.032273</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.027532</span>        <span class="mf">0.045452</span> <span class="n">s</span>

<span class="n">For</span> <span class="n">arrays</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">4096</span><span class="n">x4096</span>
<span class="n">Building</span> <span class="nb">input</span> <span class="n">circular</span> <span class="n">aperture</span>
        <span class="n">that</span> <span class="n">took</span> <span class="mf">1.938918</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">estimate</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.005327</span>        <span class="mf">0.057813</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.123481</span>        <span class="mf">0.131502</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">measure</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.030474</span>        <span class="mf">0.057851</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.119786</span>        <span class="mf">0.134453</span> <span class="n">s</span>

<span class="n">For</span> <span class="n">arrays</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">8192</span><span class="n">x8192</span>
<span class="n">Building</span> <span class="nb">input</span> <span class="n">circular</span> <span class="n">aperture</span>
        <span class="n">that</span> <span class="n">took</span> <span class="mf">78.352433</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">estimate</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.020330</span>        <span class="mf">0.325254</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">0.593469</span>        <span class="mf">0.530125</span> <span class="n">s</span>
 <span class="n">Plan</span> <span class="n">method</span><span class="o">=</span> <span class="n">measure</span>
        <span class="n">Array</span> <span class="n">alignment</span> <span class="kc">True</span>            <span class="kc">False</span>
        <span class="n">Planning</span> <span class="n">took</span>   <span class="mf">0.147264</span>        <span class="mf">0.227571</span> <span class="n">s</span>
        <span class="n">Executing</span> <span class="n">took</span>  <span class="mf">4.640368</span>        <span class="mf">0.528359</span> <span class="n">s</span>
</pre></div>
</div>
</div>
<div class="section" id="the-payoff-speed-improvements-in-poppy">
<h2>The Payoff: Speed improvements in POPPY<a class="headerlink" href="#the-payoff-speed-improvements-in-poppy" title="Permalink to this headline">¶</a></h2>
<p>For a monochromatic propagation through a 1024x1024 pupil, using 4x oversampling,
using FFTW results in about a 3x increase in performance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Using</span> <span class="n">FFTW</span><span class="p">:</span>         <span class="n">FFT</span> <span class="n">time</span> <span class="n">elapsed</span><span class="p">:</span>      <span class="mf">0.838939</span> <span class="n">s</span>
<span class="n">Using</span> <span class="n">Numpy</span><span class="o">.</span><span class="n">fft</span><span class="p">:</span>    <span class="n">FFT</span> <span class="n">time</span> <span class="n">elapsed</span><span class="p">:</span>      <span class="mf">3.010586</span> <span class="n">s</span>
</pre></div>
</div>
<p>This leads to substantial savings in total computation time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Using</span> <span class="n">FFTW</span><span class="p">:</span>          <span class="n">TIME</span> <span class="mf">1.218268</span> <span class="n">s</span> <span class="k">for</span> <span class="n">propagating</span> <span class="n">one</span> <span class="n">wavelength</span>
<span class="n">Using</span> <span class="n">Numpy</span><span class="o">.</span><span class="n">fft</span><span class="p">:</span>     <span class="n">TIME</span> <span class="mf">3.396681</span> <span class="n">s</span> <span class="k">for</span> <span class="n">propagating</span> <span class="n">one</span> <span class="n">wavelength</span>
</pre></div>
</div>
<p>Users are encouraged to try different approaches to optimizing performance on their own machines.
To enable some rudimentary benchmarking for the FFT section of the code, set <code class="xref py py-obj docutils literal notranslate"><span class="pre">poppy.conf.enable_speed_tests=True</span></code> and configure
your logging display to show debug messages. (i.e. <code class="xref py py-obj docutils literal notranslate"><span class="pre">webbpsf.configure_logging('debug')</span></code>).
Measured times will be printed in the log stream, for instance like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poppy</span>     <span class="p">:</span> <span class="n">INFO</span>     <span class="n">Calculating</span> <span class="n">PSF</span> <span class="k">with</span> <span class="mi">1</span> <span class="n">wavelengths</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">INFO</span>      <span class="n">Propagating</span> <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">1e-06</span> <span class="n">meters</span>  <span class="k">with</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.00</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>    <span class="n">Creating</span> <span class="nb">input</span> <span class="n">wavefront</span> <span class="k">with</span> <span class="n">wavelength</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">511</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.007828</span> <span class="n">meters</span><span class="o">/</span><span class="n">pixel</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>      <span class="n">Wavefront</span> <span class="ow">and</span> <span class="n">optic</span> <span class="n">Optic</span> <span class="kn">from</span> <span class="nn">fits.HDUList</span> <span class="nb">object</span> <span class="n">already</span> <span class="n">at</span> <span class="n">same</span> <span class="n">plane</span> <span class="nb">type</span><span class="p">,</span> <span class="n">no</span> <span class="n">propagation</span> <span class="n">needed</span><span class="o">.</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>      <span class="n">Multiplied</span> <span class="n">WF</span> <span class="n">by</span> <span class="n">phasor</span> <span class="k">for</span> <span class="n">Pupil</span> <span class="n">plane</span><span class="p">:</span> <span class="n">Optic</span> <span class="kn">from</span> <span class="nn">fits.HDUList</span> <span class="nb">object</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>    <span class="n">normalizing</span> <span class="n">at</span> <span class="n">first</span> <span class="n">plane</span> <span class="p">(</span><span class="n">entrance</span> <span class="n">pupil</span><span class="p">)</span> <span class="n">to</span> <span class="mf">1.0</span> <span class="n">total</span> <span class="n">intensity</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>      <span class="n">Propagating</span> <span class="n">wavefront</span> <span class="n">to</span> <span class="n">Image</span> <span class="n">plane</span><span class="p">:</span> <span class="o">-</span><span class="n">empty</span><span class="o">-</span> <span class="p">(</span><span class="n">Analytic</span><span class="p">)</span><span class="o">.</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>    <span class="n">conf</span><span class="o">.</span><span class="n">use_fftw</span> <span class="ow">is</span> <span class="kc">True</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">INFO</span>     <span class="n">using</span> <span class="n">numpy</span> <span class="n">FFT</span> <span class="n">of</span> <span class="p">(</span><span class="mi">511</span><span class="p">,</span> <span class="mi">511</span><span class="p">)</span> <span class="n">array</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>    <span class="n">using</span> <span class="n">numpy</span> <span class="n">FFT</span> <span class="n">of</span> <span class="p">(</span><span class="mi">511</span><span class="p">,</span> <span class="mi">511</span><span class="p">)</span> <span class="n">array</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">forward</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>       <span class="n">TIME</span> <span class="mf">0.051085</span> <span class="n">s</span>  <span class="k">for</span> <span class="n">the</span> <span class="n">FFT</span>                                     <span class="c1"># This line</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>      <span class="n">Multiplied</span> <span class="n">WF</span> <span class="n">by</span> <span class="n">phasor</span> <span class="k">for</span> <span class="n">Image</span> <span class="n">plane</span><span class="p">:</span> <span class="o">-</span><span class="n">empty</span><span class="o">-</span> <span class="p">(</span><span class="n">Analytic</span><span class="p">)</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">DEBUG</span>       <span class="n">TIME</span> <span class="mf">0.063745</span> <span class="n">s</span> <span class="k">for</span> <span class="n">propagating</span> <span class="n">one</span> <span class="n">wavelength</span>                   <span class="c1"># and this one</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">INFO</span>       <span class="n">Calculation</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mf">0.082</span> <span class="n">s</span>
<span class="n">poppy</span>     <span class="p">:</span> <span class="n">INFO</span>     <span class="n">PSF</span> <span class="n">Calculation</span> <span class="n">completed</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="available_opds.html" class="btn btn-neutral float-right" title="Appendix: Available Optical Path Difference (OPD) files" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sampling.html" class="btn btn-neutral float-left" title="Sampling Requirements for Numerical Accuracy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Association of Universities for Research in Astronomy
      <span class="lastupdated">
        Last updated on 20 Nov 2019.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>