

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>webbpsf.wfirst &mdash; webbpsf v0.8.0</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/astropy_logo.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/stsci.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/stsci.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          
            <a href="../../index.html" class="icon icon-home"> webbpsf
            
            <img src="../../_static/stsci_pri_combo_mark_white.png" class="logo" />
          </a>

          
            
            
              <div class="version">
                0.8.0
              </div>
            
          
          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
  
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Requirements &amp; Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Using WebbPSF via the Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jwst.html">JWST Instrument Model Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wfirst.html">WFIRST Instrument Model Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../psf_grids.html">Using PSF Grids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more_examples.html">More Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../poppy.html">Overview of POPPY (Physical Optics Propagation in Python)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">Detailed API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../help.html">Diagnostics &amp; Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sampling.html">Sampling Requirements for Numerical Accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fft_optimization.html">Optimizing FFT Performance for PSF Computations with FFTW</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../available_opds.html">Appendix: Available Optical Path Difference (OPD) files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">Appendix: Instrument Property References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gui.html">(Deprecated)  Graphical User Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release.html">Developer Notes: Releasing a new version of WebbPSF</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">webbpsf</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../webbpsf.html">webbpsf</a> &raquo;</li>
        
      <li>webbpsf.wfirst</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for webbpsf.wfirst</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">==============================</span>
<span class="sd">WFIRST Instruments (pre-alpha)</span>
<span class="sd">==============================</span>

<span class="sd">WARNING: This model has not yet been validated against other PSF</span>
<span class="sd">         simulations, and uses several approximations (e.g. for</span>
<span class="sd">         mirror polishing errors, which are taken from HST).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">poppy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">webbpsf_core</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">griddata</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;webbpsf&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pprint</span>


<span class="k">class</span> <span class="nc">WavelengthDependenceInterpolator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;WavelengthDependenceInterpolator can be configured with</span>
<span class="sd">    `n_zernikes` worth of Zernike coefficients at up to `n_wavelengths`</span>
<span class="sd">    wavelengths, and will let you `get_aberration_terms` for any</span>
<span class="sd">    wavelength in range interpolated linearly between measured/known</span>
<span class="sd">    points</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_wavelengths</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">n_zernikes</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_wavelengths</span> <span class="o">=</span> <span class="n">n_wavelengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_zernikes</span> <span class="o">=</span> <span class="n">n_zernikes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aberration_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_wavelengths</span><span class="p">,</span> <span class="n">n_zernikes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_aberration_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">zernike_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Supply a reference `wavelength` and a `zernike_array`</span>
<span class="sd">        (of length `n_zernikes`) where the aberration is known</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_wavelengths_set</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wavelength</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span> <span class="ow">and</span> <span class="n">n_wavelengths_set</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_wavelengths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
            <span class="n">aberration_row_idx</span> <span class="o">=</span> <span class="n">n_wavelengths_set</span>  <span class="c1"># which is now index of last row</span>
        <span class="k">elif</span> <span class="n">wavelength</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="p">:</span>
            <span class="n">aberration_row_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># can&#39;t add more wavelengths without allocating new _aberration_terms array</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Already have information at </span><span class="si">{}</span><span class="s2"> wavelengths &quot;</span>
                             <span class="s2">&quot;(pass larger n_wavelengths to __init__?)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_wavelengths</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zernike_array</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_zernikes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected </span><span class="si">{}</span><span class="s2"> aberration terms (pass different &quot;</span>
                             <span class="s2">&quot;n_zernikes to __init__?)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_zernikes</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aberration_terms</span><span class="p">[</span><span class="n">aberration_row_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">zernike_array</span>

    <span class="k">def</span> <span class="nf">get_aberration_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the Zernike coefficients as interpolated for this</span>
<span class="sd">        `wavelength`&quot;&quot;&quot;</span>
        <span class="c1"># return array of length n_zernikes interpolated for this wavelength</span>
        <span class="k">if</span> <span class="n">wavelength</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="p">:</span>
            <span class="c1"># aberration known exactly for this wavelength</span>
            <span class="n">aberration_row_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aberration_terms</span><span class="p">[</span><span class="n">aberration_row_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we have to interpolate @ this wavelength</span>
            <span class="n">aberration_terms</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aberration_terms</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">aberration_terms</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
                    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                <span class="n">wavelength_closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="p">))</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Attempted to get aberrations at wavelength </span><span class="si">{:.2g}</span><span class="s2"> &quot;</span>
                          <span class="s2">&quot;outside the range of the reference data; clipping to closest wavelength </span><span class="si">{:.2g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">wavelength</span><span class="p">,</span> <span class="n">wavelength_closest</span><span class="p">))</span>

                <span class="n">aberration_terms</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aberration_terms</span><span class="p">,</span> <span class="n">wavelength_closest</span><span class="p">,</span>
                                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">aberration_terms</span>

<span class="k">class</span> <span class="nc">FieldDependentAberration</span><span class="p">(</span><span class="n">poppy</span><span class="o">.</span><span class="n">ZernikeWFE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;FieldDependentAberration incorporates aberrations that</span>
<span class="sd">    are interpolated in wavelength, x, and y pixel positions by</span>
<span class="sd">    computing the Zernike coefficients for a particular wavelength</span>
<span class="sd">    and position.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;By default, `get_aberration_terms` will zero out Z1, Z2, and Z3</span>
<span class="sd">    (piston, tip, and tilt) as they are not meaningful for telescope</span>
<span class="sd">    PSF calculations (the former is irrelevant, the latter two would</span>
<span class="sd">    be handled by a distortion solution). Change</span>
<span class="sd">    `_omit_piston_tip_tilt` to False to include the Z1-3 terms.&quot;&quot;&quot;</span>
    <span class="n">_omit_piston_tip_tilt</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_field_position</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_width</span><span class="p">,</span> <span class="n">pixel_height</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Field-dependent Aberration&quot;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interp_order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_height</span> <span class="o">=</span> <span class="n">pixel_width</span><span class="p">,</span> <span class="n">pixel_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_position</span> <span class="o">=</span> <span class="n">pixel_width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pixel_height</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_interpolators</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diam</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="mf">2.0</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FieldDependentAberration</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
            <span class="n">oversample</span><span class="o">=</span><span class="n">oversample</span><span class="p">,</span>
            <span class="n">interp_order</span><span class="o">=</span><span class="n">interp_order</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_opd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Zernike coefficients (for ZernikeWFE.getOPD) based</span>
<span class="sd">        on the wavelength of the incoming wavefront and the pixel</span>
<span class="sd">        position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">poppy</span><span class="o">.</span><span class="n">Wavefront</span><span class="p">):</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wave</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wave</span><span class="o">.</span><span class="n">wavelength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span> <span class="o">=</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_aberration_terms</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">FieldDependentAberration</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_opd</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">field_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_position</span>

    <span class="nd">@field_position</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">field_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the x and y pixel position on the detector for which to</span>
<span class="sd">        interpolate aberrations&quot;&quot;&quot;</span>
        <span class="n">x_pixel</span><span class="p">,</span> <span class="n">y_pixel</span> <span class="o">=</span> <span class="n">position</span>
        <span class="k">if</span> <span class="n">x_pixel</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_width</span> <span class="ow">or</span> <span class="n">x_pixel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Requested pixel_x position lies outside &quot;</span>
                             <span class="s2">&quot;the detector width (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x_pixel</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">y_pixel</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_height</span> <span class="ow">or</span> <span class="n">y_pixel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Requested pixel_y position lies outside &quot;</span>
                             <span class="s2">&quot;the detector height (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_pixel</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_field_position</span> <span class="o">=</span> <span class="n">x_pixel</span><span class="p">,</span> <span class="n">y_pixel</span>

    <span class="k">def</span> <span class="nf">add_field_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_pixel</span><span class="p">,</span> <span class="n">y_pixel</span><span class="p">,</span> <span class="n">interpolator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Supply a wavelength-space interpolator for a pixel position</span>
<span class="sd">        on the detector&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_interpolators</span><span class="p">[(</span><span class="n">x_pixel</span><span class="p">,</span> <span class="n">y_pixel</span><span class="p">)]</span> <span class="o">=</span> <span class="n">interpolator</span>

    <span class="k">def</span> <span class="nf">get_aberration_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Supply the Zernike coefficients for the aberration based on</span>
<span class="sd">        the wavelength and pixel position on the detector&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_interpolators</span><span class="p">:</span>
            <span class="c1"># short path: this is a known point</span>
            <span class="n">interpolator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_interpolators</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_position</span><span class="p">]</span>
            <span class="n">coefficients</span> <span class="o">=</span> <span class="n">interpolator</span><span class="o">.</span><span class="n">get_aberration_terms</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get aberrations at all field points</span>
            <span class="n">field_points</span><span class="p">,</span> <span class="n">aberration_terms</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">field_point_coords</span><span class="p">,</span> <span class="n">point_interpolator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_interpolators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_point_coords</span><span class="p">)</span>
                <span class="n">aberration_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_interpolator</span><span class="o">.</span><span class="n">get_aberration_terms</span><span class="p">(</span><span class="n">wavelength</span><span class="p">))</span>
            <span class="n">aberration_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aberration_terms</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aberration_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;computed aberration array is not 2D &quot;</span> \
                                                     <span class="s2">&quot;(inconsistent number of Zernike terms &quot;</span> \
                                                     <span class="s2">&quot;at each point?)&quot;</span>

            <span class="n">field_position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_position</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4092</span><span class="p">))</span>
            <span class="n">coefficients</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">field_points</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aberration_terms</span><span class="p">),</span>
                <span class="n">field_position</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not get aberrations for input field point&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omit_piston_tip_tilt</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Omitting piston/tip/tilt&quot;</span><span class="p">)</span>
            <span class="n">coefficients</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># omit piston, tip, and tilt Zernikes</span>
        <span class="k">return</span> <span class="n">coefficients</span>


<span class="k">def</span> <span class="nf">_load_wfi_detector_aberrations</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">ascii</span>
    <span class="n">zernike_table</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">detectors</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">build_detector_from_table</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">zernike_table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a FieldDependentAberration optic for a detector using</span>
<span class="sd">        Zernikes Z1-Z22 at various wavelengths and field points&quot;&quot;&quot;</span>
        <span class="n">single_detector_info</span> <span class="o">=</span> <span class="n">zernike_table</span><span class="p">[</span><span class="n">zernike_table</span><span class="p">[</span><span class="s1">&#39;sca&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">number</span><span class="p">]</span>
        <span class="n">field_points</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">single_detector_info</span><span class="p">[</span><span class="s1">&#39;field_point&#39;</span><span class="p">])</span>
        <span class="n">interpolators</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">detector</span> <span class="o">=</span> <span class="n">FieldDependentAberration</span><span class="p">(</span>
            <span class="mi">4096</span><span class="p">,</span>
            <span class="mi">4096</span><span class="p">,</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">WFIRSTInstrument</span><span class="o">.</span><span class="n">PUPIL_RADIUS</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Field Dependent Aberration (SCA</span><span class="si">{:02}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">field_id</span> <span class="ow">in</span> <span class="n">field_points</span><span class="p">:</span>
            <span class="n">field_point_rows</span> <span class="o">=</span> <span class="n">single_detector_info</span><span class="p">[</span><span class="n">single_detector_info</span><span class="p">[</span><span class="s1">&#39;field_point&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">field_id</span><span class="p">]</span>
            <span class="n">local_x</span><span class="p">,</span> <span class="n">local_y</span> <span class="o">=</span> <span class="n">field_point_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;local_x&#39;</span><span class="p">],</span> <span class="n">field_point_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;local_y&#39;</span><span class="p">]</span>
            <span class="n">interpolator</span> <span class="o">=</span> <span class="n">build_wavelength_dependence</span><span class="p">(</span><span class="n">field_point_rows</span><span class="p">)</span>

            <span class="n">midpoint_pixel</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="c1"># (local_x in mm / 10 um pixel size) -&gt; * 1e2</span>
            <span class="c1"># local_x and _y range from -20.44 to +20.44, so adding to the midpoint pixel</span>
            <span class="c1"># makes sense to place (-20.44, -20.44) at (4, 4)</span>
            <span class="n">pixx</span><span class="p">,</span> <span class="n">pixy</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">midpoint_pixel</span> <span class="o">+</span> <span class="n">local_x</span> <span class="o">*</span> <span class="mf">1e2</span><span class="p">),</span>
                          <span class="nb">round</span><span class="p">(</span><span class="n">midpoint_pixel</span> <span class="o">+</span> <span class="n">local_y</span> <span class="o">*</span> <span class="mf">1e2</span><span class="p">))</span>

            <span class="n">detector</span><span class="o">.</span><span class="n">add_field_point</span><span class="p">(</span><span class="n">pixx</span><span class="p">,</span> <span class="n">pixy</span><span class="p">,</span> <span class="n">interpolator</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">detector</span>

    <span class="k">def</span> <span class="nf">build_wavelength_dependence</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build an interpolator object that interpolates Z1-Z22 in</span>
<span class="sd">        wavelength space&quot;&quot;&quot;</span>
        <span class="n">wavelengths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">])</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">WavelengthDependenceInterpolator</span><span class="p">(</span><span class="n">n_wavelengths</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">),</span>
                                                        <span class="n">n_zernikes</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">):</span>
                <span class="n">z</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Z</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">interpolator</span><span class="o">.</span><span class="n">set_aberration_terms</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">interpolator</span>

    <span class="n">detector_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">zernike_table</span><span class="p">[</span><span class="s1">&#39;sca&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">detid</span> <span class="ow">in</span> <span class="n">detector_ids</span><span class="p">:</span>
        <span class="n">detectors</span><span class="p">[</span><span class="s2">&quot;SCA</span><span class="si">{:02}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">detid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">build_detector_from_table</span><span class="p">(</span><span class="n">detid</span><span class="p">,</span> <span class="n">zernike_table</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">detectors</span>


<span class="k">class</span> <span class="nc">WFIRSTInstrument</span><span class="p">(</span><span class="n">webbpsf_core</span><span class="o">.</span><span class="n">SpaceTelescopeInstrument</span><span class="p">):</span>
    <span class="n">PUPIL_RADIUS</span> <span class="o">=</span> <span class="mf">2.4</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    WFIRSTInstrument contains data and functionality common to WFIRST</span>
<span class="sd">    instruments, such as setting the pupil shape</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">telescope</span> <span class="o">=</span> <span class="s2">&quot;WFIRST&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WFIRSTInstrument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># slightly different versions of the following two functions</span>
    <span class="c1"># from the parent superclass</span>
    <span class="c1"># in order to interface with the FieldDependentAberration class</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">detector_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The pixel position in (X, Y) on the detector&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_detector</span><span class="p">]</span><span class="o">.</span><span class="n">field_position</span>

    <span class="nd">@detector_position</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">detector_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="c1"># exact copy of superclass function except we save the</span>
        <span class="c1"># into a different location.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Detector pixel coordinates must be pairs of nonnegative numbers, &quot;</span>
                             <span class="s2">&quot;not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Detector pixel coordinates must be nonnegative integers&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detector_npixels</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detector_npixels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The maximum allowed detector pixel &quot;</span>
                             <span class="s2">&quot;coordinate value is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_detector_npixels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_detector</span><span class="p">]</span><span class="o">.</span><span class="n">field_position</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_get_aberrations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the OpticalElement that applies the field-dependent</span>
<span class="sd">        optical aberrations. (Called in _get_optical_system.)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_detector</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_fits_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate FITS Header keywords&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WFIRSTInstrument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_fits_header</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DETXPIXL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="s1">&#39;X pixel position (for field dependent aberrations)&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DETYPIXL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="s1">&#39;Y pixel position (for field dependent aberrations)&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="p">,</span> <span class="s1">&#39;Detector selected&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">WFIPupilController</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a helper class for the WFI and is used to swap in</span>
<span class="sd">    the correct pupil each time the detector is changed.</span>
<span class="sd">    The pupil depends on the selected detector, filter and the</span>
<span class="sd">    pupil_mask flag provided by the user.</span>
<span class="sd">    The user should not interact with this class directly, only</span>
<span class="sd">    through the API provided through the WFI class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_basepath</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Paths to the two possible pupils. The correct one is selected based on requested</span>
        <span class="c1"># wavelengths in _validate_config()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unmasked_pupil_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_masked_pupil_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># List of filters that need the masked pupil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_masked_filters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F184&#39;</span><span class="p">]</span>

        <span class="c1"># Flag to en-/disable automatic selection of the appropriate pupil_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_pupil</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_mask</span> <span class="o">=</span> <span class="s2">&quot;AUTO&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil_mask_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AUTO&#39;</span><span class="p">,</span> <span class="s1">&#39;COLD_PUPIL&#39;</span><span class="p">,</span> <span class="s1">&#39;UNMASKED&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_currently_masked</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_base_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datapath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the path to the WebbPSF data files.</span>
<span class="sd">        This should be set before this class is used.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        datapath : string</span>
<span class="sd">            Path to WebbPSF-WFI data files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span> <span class="o">=</span> <span class="n">datapath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span><span class="p">,</span> <span class="s2">&quot;pupils&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pupil</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil</span>

    <span class="nd">@pupil</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pupil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pupil_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pupil_mask types:</span>
<span class="sd">        - &quot;AUTO&quot;:</span>
<span class="sd">            Automatically select pupil</span>
<span class="sd">        - &quot;COLD_PUPIL&quot;:</span>
<span class="sd">            Masked pupil override</span>
<span class="sd">        - &quot;UNMASKED&quot;:</span>
<span class="sd">            Unmasked pupil override</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_mask</span>

    <span class="nd">@pupil_mask</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pupil_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the pupil mask</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        name : string</span>
<span class="sd">            Name of setting.</span>
<span class="sd">            Settings:</span>
<span class="sd">                - &quot;AUTO&quot;:</span>
<span class="sd">                    Automatically select pupil</span>
<span class="sd">                - &quot;COLD_PUPIL&quot;:</span>
<span class="sd">                    Masked pupil override</span>
<span class="sd">                - &quot;UNMASKED&quot;:</span>
<span class="sd">                    Unmasked pupil override</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;AUTO&quot;</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auto_pupil</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using default pupil mask.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;COLD_PUPIL&quot;</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auto_pupil</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using custom pupil mask: Masked Pupil.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;UNMASKED&quot;</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auto_pupil</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using custom pupil mask: Unmasked Pupil.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument </span><span class="si">{0}</span><span class="s2"> doesn&#39;t have a pupil mask called &#39;</span><span class="si">{1}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pupil mask setting is not valid or empty.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_mask</span> <span class="o">=</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_pupil</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_pupil_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the masked and unmasked pupil paths according to the SCA selected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_basepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;update_pupil_path called before pupil file path is set&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">detector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Detector was not set when trying to set pupil file path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;SCA&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">detector</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unidentified detector selected, could not assign pupil&quot;</span><span class="p">)</span>

        <span class="n">detector</span> <span class="o">=</span> <span class="n">detector</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">detector</span><span class="p">[</span><span class="mi">3</span><span class="p">:])))</span>  <span class="c1"># example &quot;SCA01&quot; -&gt; &quot;SCA1&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unmasked_pupil_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pupil_basepath</span><span class="p">,</span>
                                                 <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_rim_mask.fits.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">detector</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_masked_pupil_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pupil_basepath</span><span class="p">,</span>
                                               <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_full_mask.fits.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">detector</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_pupil</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_pupil</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the actual pupil by setting the pupil variable</span>
<span class="sd">        to the correct pupil path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_basepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;update pupil called before pupil file path is set&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;AUTO&#39;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_mask</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_currently_masked</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked_pupil_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unmasked_pupil_path</span>
        <span class="k">elif</span> <span class="s2">&quot;COLD_PUPIL&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_mask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked_pupil_path</span>
        <span class="k">elif</span> <span class="s2">&quot;UNMASKED&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_mask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unmasked_pupil_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pupil mask setting is not valid or empty.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_pupil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates that the WFI is configured sensibly</span>

<span class="sd">        This mainly consists of selecting the masked or unmasked pupil</span>
<span class="sd">        appropriately based on the wavelengths requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_pupil</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked_filters</span><span class="p">:</span>
                <span class="c1"># use masked pupil optic</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked_pupil_path</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using the masked WFI pupil shape based on filter requested&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># use unmasked pupil optic</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unmasked_pupil_path</span>
                <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using the unmasked WFI pupil shape based on filter requested&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the user has set the pupil to a custom value, let them worry about the</span>
            <span class="c1"># correct shape it should have</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">remove_pupil_mask_override</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing custom pupil mask&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil_mask</span> <span class="o">=</span> <span class="s1">&#39;AUTO&#39;</span>


<div class="viewcode-block" id="WFI"><a class="viewcode-back" href="../../api/webbpsf.WFI.html#webbpsf.WFI">[docs]</a><span class="k">class</span> <span class="nc">WFI</span><span class="p">(</span><span class="n">WFIRSTInstrument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    WFI represents the WFIRST wide field imager</span>
<span class="sd">    for the WFIRST mission</span>

<span class="sd">    WARNING: This model has not yet been validated against other PSF</span>
<span class="sd">             simulations, and uses several approximations (e.g. for</span>
<span class="sd">             mirror polishing errors, which are taken from HST).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiate WFI</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        set_pupil_mask_on : bool or None</span>
<span class="sd">            Set to True or False to force using or not using the cold pupil mask,</span>
<span class="sd">            or to None for the automatic behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixelscale</span> <span class="o">=</span> <span class="mf">110e-3</span>  <span class="c1"># arcsec/px, WFIRST-AFTA SDT report final version (p. 91)</span>

        <span class="c1"># Initialize the pupil controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span> <span class="o">=</span> <span class="n">WFIPupilController</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">WFI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;WFI&quot;</span><span class="p">,</span> <span class="n">pixelscale</span><span class="o">=</span><span class="n">pixelscale</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">set_base_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pupil_mask_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">pupil_mask_list</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detector_npixels</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span> <span class="o">=</span> <span class="n">_load_wfi_detector_aberrations</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span><span class="p">,</span> <span class="s1">&#39;wim_zernikes_cycle8.csv&#39;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="s1">&#39;SCA01&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opd_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_WebbPSF_basepath</span><span class="p">,</span> <span class="s1">&#39;upscaled_HST_OPD.fits&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupilopd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opd_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates that the WFI is configured sensibly</span>

<span class="sd">        This mainly consists of selecting the masked or unmasked pupil</span>
<span class="sd">        appropriately based on the wavelengths requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">validate_pupil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WFI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_validate_config</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@WFIRSTInstrument</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid detector. Valid detector names are: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_list</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detector</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">update_pupil_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pupil</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">pupil</span>

    <span class="nd">@pupil</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pupil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># self._pupil_controller is not available at initiation thus</span>
        <span class="c1"># we must ignore any assignments at super(WFI, self).__init__(...)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pupil_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">pupil_mask</span>

    <span class="nd">@WFIRSTInstrument</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># force to uppercase</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument </span><span class="si">%s</span><span class="s2"> doesn&#39;t have a filter called </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">validate_pupil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>

    <span class="nd">@pupil_mask</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pupil_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the pupil mask</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        name : string</span>
<span class="sd">            Name of setting.</span>
<span class="sd">            Settings:</span>
<span class="sd">                - &quot;AUTO&quot;:</span>
<span class="sd">                    Automatically select pupil</span>
<span class="sd">                - &quot;COLD_PUPIL&quot;:</span>
<span class="sd">                    Masked pupil override</span>
<span class="sd">                - &quot;UNMASKED&quot;:</span>
<span class="sd">                    Unmasked pupil override</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">pupil_mask</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">_addAdditionalOptics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optsys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">optsys</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_unmasked_pupil_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">_unmasked_pupil_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_masked_pupil_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pupil_controller</span><span class="o">.</span><span class="n">_masked_pupil_path</span></div>


<div class="viewcode-block" id="CGI"><a class="viewcode-back" href="../../api/webbpsf.CGI.html#webbpsf.CGI">[docs]</a><span class="k">class</span> <span class="nc">CGI</span><span class="p">(</span><span class="n">WFIRSTInstrument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    WFIRST Coronagraph Instrument</span>

<span class="sd">    Simulates the PSF of the WFIRST coronagraph.</span>

<span class="sd">    Current functionality is limited to the Shaped Pupil Coronagraph (SPC)</span>
<span class="sd">    observing modes, and these modes are only simulated with static, unaberrated</span>
<span class="sd">    wavefronts, without relay optics and without DM control. The design</span>
<span class="sd">    respresented here is an approximation to a baseline concept, and will be</span>
<span class="sd">    subject to change based on trades studies and technology development.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mode : str</span>
<span class="sd">        CGI observing mode. If not specified, the __init__ function</span>
<span class="sd">        will set this to a default mode &#39;CHARSPC_F660&#39;</span>
<span class="sd">    pixelscale : float</span>
<span class="sd">        Detector pixelscale. If not specified, the pixelscale will default to</span>
<span class="sd">        0.02 arcsec for configurations usint the IMAGER camera and 0.025 arcsec</span>
<span class="sd">        for the IFS.</span>
<span class="sd">    fov_arcsec : float</span>
<span class="sd">        Field of view in arcseconds. If not specified, the field of view will</span>
<span class="sd">        default to 3.20 arcsec for the IMAGER camera and 1.76 arcsec for the IFS.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">camera_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IMAGER&#39;</span><span class="p">,</span> <span class="s1">&#39;IFS&#39;</span><span class="p">]</span>
    <span class="n">filter_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F660&#39;</span><span class="p">,</span> <span class="s1">&#39;F721&#39;</span><span class="p">,</span> <span class="s1">&#39;F770&#39;</span><span class="p">,</span> <span class="s1">&#39;F890&#39;</span><span class="p">]</span>
    <span class="n">apodizer_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CHARSPC&#39;</span><span class="p">,</span> <span class="s1">&#39;DISKSPC&#39;</span><span class="p">]</span>
    <span class="n">fpm_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CHARSPC_F660_BOWTIE&#39;</span><span class="p">,</span> <span class="s1">&#39;CHARSPC_F770_BOWTIE&#39;</span><span class="p">,</span> <span class="s1">&#39;CHARSPC_F890_BOWTIE&#39;</span><span class="p">,</span> <span class="s1">&#39;DISKSPC_F721_ANNULUS&#39;</span><span class="p">]</span>
    <span class="n">lyotstop_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LS30D88&#39;</span><span class="p">]</span>

    <span class="n">_mode_table</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># MODE             CAMERA    FILTER  APODIZER   FPM             LYOT STOP</span>
        <span class="s1">&#39;CHARSPC_F660&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;IFS&#39;</span><span class="p">,</span> <span class="s1">&#39;F660&#39;</span><span class="p">,</span> <span class="s1">&#39;CHARSPC&#39;</span><span class="p">,</span> <span class="s1">&#39;CHARSPC_F660_BOWTIE&#39;</span><span class="p">,</span> <span class="s1">&#39;LS30D88&#39;</span><span class="p">),</span>
        <span class="s1">&#39;CHARSPC_F770&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;IFS&#39;</span><span class="p">,</span> <span class="s1">&#39;F770&#39;</span><span class="p">,</span> <span class="s1">&#39;CHARSPC&#39;</span><span class="p">,</span> <span class="s1">&#39;CHARSPC_F770_BOWTIE&#39;</span><span class="p">,</span> <span class="s1">&#39;LS30D88&#39;</span><span class="p">),</span>
        <span class="s1">&#39;CHARSPC_F890&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;IFS&#39;</span><span class="p">,</span> <span class="s1">&#39;F890&#39;</span><span class="p">,</span> <span class="s1">&#39;CHARSPC&#39;</span><span class="p">,</span> <span class="s1">&#39;CHARSPC_F890_BOWTIE&#39;</span><span class="p">,</span> <span class="s1">&#39;LS30D88&#39;</span><span class="p">),</span>
        <span class="s1">&#39;DISKSPC_F721&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;IMAGER&#39;</span><span class="p">,</span> <span class="s1">&#39;F721&#39;</span><span class="p">,</span> <span class="s1">&#39;DISKSPC&#39;</span><span class="p">,</span> <span class="s1">&#39;DISKSPC_F721_ANNULUS&#39;</span><span class="p">,</span> <span class="s1">&#39;LS30D88&#39;</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pixelscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fov_arcsec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_static_opd</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CGI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;CGI&quot;</span><span class="p">,</span> <span class="n">pixelscale</span><span class="o">=</span><span class="n">pixelscale</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detector_npixels</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span> <span class="o">=</span> <span class="p">{</span><span class="n">camera</span><span class="p">:</span> <span class="s1">&#39;placeholder&#39;</span> <span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_list</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pupil_mask_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lyotstop_list</span>  <span class="c1"># alias for use in webbpsf_core</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_mask_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpm_list</span>  <span class="c1"># alias for use in webbpsf_core</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_WebbPSF_basepath</span><span class="p">,</span> <span class="s1">&#39;AFTA_CGI_C5_Pupil_onax_256px_flip.fits&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">apply_static_opd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pupilopd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_WebbPSF_basepath</span><span class="p">,</span> <span class="s1">&#39;CGI&#39;</span><span class="p">,</span> <span class="s1">&#39;OPD&#39;</span><span class="p">,</span> <span class="s1">&#39;CGI_static_OPD.fits&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pupilopd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aberration_optic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;force_coron&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="c1"># Allow the user to pre-emptively override the default instrument FoV and pixel scale</span>
        <span class="k">if</span> <span class="n">fov_arcsec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fov_arcsec</span> <span class="o">=</span> <span class="n">fov_arcsec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_override_fov</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_override_fov</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">pixelscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pixelscale</span> <span class="o">=</span> <span class="n">pixelscale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_override_pixelscale</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_override_pixelscale</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_mode_table</span><span class="p">()</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Since the mode was not specified at instantiation, defaulting to CHARSPC_F660&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;CHARSPC_F660&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">camera</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently selected camera name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span>

    <span class="nd">@camera</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">camera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># force to uppercase</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument </span><span class="si">{0}</span><span class="s2"> doesn&#39;t have a camera called </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;IMAGER&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fov_arcsec&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_fov</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fov_arcsec</span> <span class="o">=</span> <span class="mf">3.2</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pixelscale&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_pixelscale</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pixelscale</span> <span class="o">=</span> <span class="mf">0.020</span>  <span class="c1"># Nyquist at 465 nm</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># default to &#39;IFS&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fov_arcsec&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_fov</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fov_arcsec</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.82</span>  <span class="c1"># 2015 SDT report, Section 3.4.1.1.1:</span>
                                            <span class="c1"># IFS has 76 lenslets across the (2 x 0.82) arcsec FoV.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pixelscale&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_pixelscale</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pixelscale</span> <span class="o">=</span> <span class="mf">0.025</span>  <span class="c1"># Nyquist at 600 nm</span>

    <span class="c1"># for CGI, there is one detector per camera and it should be set automatically.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">detector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span>

    <span class="nd">@detector</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t set detector directly for CGI; set camera instead.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently selected filter name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span>

    <span class="nd">@filter</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># force to uppercase</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument </span><span class="si">{0}</span><span class="s2"> doesn&#39;t have a filter called </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">apodizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently selected apodizer name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apodizer</span>

    <span class="nd">@apodizer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">apodizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># force to uppercase</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apodizer_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument </span><span class="si">{0}</span><span class="s2"> doesn&#39;t have a apodizer called </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apodizer</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;DISKSPC&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apodizer_fname</span> <span class="o">=</span> \
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span><span class="p">,</span> <span class="s2">&quot;optics/DISKSPC_SP_256pix.fits.gz&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># for now, default to CHARSPC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apodizer_fname</span> <span class="o">=</span> \
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span><span class="p">,</span> <span class="s2">&quot;optics/CHARSPC_SP_256pix.fits.gz&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fpm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently selected FPM name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fpm</span>

    <span class="nd">@fpm</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">fpm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="c1"># force to uppercase</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpm_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument </span><span class="si">{0}</span><span class="s2"> doesn&#39;t have a FPM called </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fpm</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DISKSPC&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fpmres</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_owa</span> <span class="o">=</span> <span class="mf">20.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Mfpm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fpmres</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owa</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fpm_fname</span> <span class="o">=</span> \
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span><span class="p">,</span>
                             <span class="s2">&quot;optics/DISKSPC_FPM_65WA200_360deg_-_FP1res</span><span class="si">{0:d}</span><span class="s2">_evensamp_D</span><span class="si">{1:03d}</span><span class="s2">_</span><span class="si">{2:s}</span><span class="s2">.fits.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_fpmres</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mfpm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fpmres</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_owa</span> <span class="o">=</span> <span class="mf">9.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Mfpm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fpmres</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owa</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fpm_fname</span> <span class="o">=</span> \
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span><span class="p">,</span>
                             <span class="s2">&quot;optics/CHARSPC_FPM_25WA90_2x65deg_-_FP1res</span><span class="si">{0:d}</span><span class="s2">_evensamp_D</span><span class="si">{1:03d}</span><span class="s2">_</span><span class="si">{2:s}</span><span class="s2">.fits.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_fpmres</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mfpm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lyotstop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently selected Lyot stop name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lyotstop</span>

    <span class="nd">@lyotstop</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">lyotstop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># preserve case for this one since we&#39;re used to that with the lyot mask names</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lyotstop_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument </span><span class="si">{0}</span><span class="s2"> doesn&#39;t have a Lyot mask called </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lyotstop</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lyotstop_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapath</span><span class="p">,</span> <span class="s2">&quot;optics/SPC_LS_30D88_256pix.fits.gz&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Available Observation Modes&quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_table</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keys</span>

    <span class="c1"># mode works differently since it&#39;s a meta-property that affects the other ones:</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently selected mode name&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">modename</span><span class="p">,</span> <span class="n">settings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">apodizer</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpm</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lyotstop</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                <span class="k">return</span> <span class="n">modename</span>
        <span class="k">return</span> <span class="s1">&#39;Custom&#39;</span>

    <span class="nd">@mode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument </span><span class="si">{0}</span><span class="s2"> doesn&#39;t have a mode called </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_table</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apodizer</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpm</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lyotstop</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Set the following optical configuration:&#39;</span><span class="p">)</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;camera = </span><span class="si">{0}</span><span class="s1">, filter = </span><span class="si">{1}</span><span class="s1">, apodizer = </span><span class="si">{2}</span><span class="s1">, fpm = </span><span class="si">{3}</span><span class="s1">, lyotstop = </span><span class="si">{4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>\
                  <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apodizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lyotstop</span><span class="p">))</span>

<div class="viewcode-block" id="CGI.print_mode_table"><a class="viewcode-back" href="../../api/webbpsf.CGI.html#webbpsf.CGI.print_mode_table">[docs]</a>    <span class="k">def</span> <span class="nf">print_mode_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the table of observing mode options and their associated optical configuration&quot;&quot;&quot;</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Printing the table of WFIRST CGI observing modes supported by WebbPSF.&quot;</span><span class="p">)</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Each is defined by a combo of camera, filter, apodizer, &quot;</span>
                  <span class="s2">&quot;focal plane mask (FPM), and Lyot stop settings:&quot;</span><span class="p">)</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode_table</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">detector_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The pixel position in (X, Y) on the detector&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span>

    <span class="nd">@detector_position</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">detector_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Detector position not adjustable for CGI&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CGI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_validate_config</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_addAdditionalOptics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optsys</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add coronagraphic or spectrographic optics for WFIRST CGI.&quot;&quot;&quot;</span>

        <span class="n">trySAM</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;pupil_shift_x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;pupil_shift_x&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="s1">&#39;pupil_shift_y&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;pupil_shift_y&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;pupil_shift_x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;pupil_shift_y&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Add the shaped pupil apodizer</span>
        <span class="n">optsys</span><span class="o">.</span><span class="n">add_pupil</span><span class="p">(</span><span class="n">transmission</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_apodizer_fname</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apodizer</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Add the FPM</span>
        <span class="n">optsys</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">transmission</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fpm_fname</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fpm</span><span class="p">)</span>

        <span class="c1"># Add Lyot stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lyotstop</span>
        <span class="n">optsys</span><span class="o">.</span><span class="n">add_pupil</span><span class="p">(</span><span class="n">transmission</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lyotstop_fname</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lyotstop</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">)</span>

        <span class="c1"># Cast as MatrixFTCoronagraph; this configures the detector</span>
        <span class="n">occ_box_size</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">mft_optsys</span> <span class="o">=</span> <span class="n">poppy</span><span class="o">.</span><span class="n">MatrixFTCoronagraph</span><span class="p">(</span><span class="n">optsys</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="n">oversample</span><span class="p">,</span> <span class="n">occulter_box</span><span class="o">=</span><span class="n">occ_box_size</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mft_optsys</span><span class="p">,</span> <span class="n">trySAM</span><span class="p">,</span> <span class="n">occ_box_size</span>

    <span class="k">def</span> <span class="nf">_get_aberrations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the OpticalElement that applies the field-dependent</span>
<span class="sd">        optical aberrations. (Called in _get_optical_system.)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_fits_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate FITS Header keywords&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WFIRSTInstrument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_fits_header</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">pupil_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="p">)</span>
        <span class="n">apodizer_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apodizer_fname</span><span class="p">)</span>
        <span class="n">fpm_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fpm_fname</span><span class="p">)</span>
        <span class="n">lyotstop_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lyotstop_fname</span><span class="p">)</span>

        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;MODE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Observing mode&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;CAMERA&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Imager or IFS&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;APODIZER&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apodizer</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Apodizer&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;APODTRAN&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apodizer_fname</span><span class="p">),</span>
                             <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Apodizer transmission&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;PUPLSCAL&#39;</span><span class="p">,</span> <span class="n">apodizer_hdr</span><span class="p">[</span><span class="s1">&#39;PUPLSCAL&#39;</span><span class="p">],</span>
                             <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Apodizer pixel scale in m/pixel&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;PUPLDIAM&#39;</span><span class="p">,</span> <span class="n">apodizer_hdr</span><span class="p">[</span><span class="s1">&#39;PUPLDIAM&#39;</span><span class="p">],</span>
                             <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Full apodizer array size, incl padding.&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;FPM&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpm</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Focal plane mask&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;FPMTRAN&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fpm_fname</span><span class="p">),</span>
                             <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;FPM transmission&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;FPMSCAL&#39;</span><span class="p">,</span> <span class="n">fpm_hdr</span><span class="p">[</span><span class="s1">&#39;PIXSCALE&#39;</span><span class="p">],</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;FPM spatial sampling, arcsec/pix&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;LYOTSTOP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lyotstop</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Lyot stop&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;LSTRAN&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lyotstop_fname</span><span class="p">),</span>
                             <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Lyot stop transmission&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;PUPLSCAL&#39;</span><span class="p">,</span> <span class="n">lyotstop_hdr</span><span class="p">[</span><span class="s1">&#39;PUPLSCAL&#39;</span><span class="p">],</span>
                             <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Lyot stop pixel scale in m/pixel&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;PUPLDIAM&#39;</span><span class="p">,</span> <span class="n">lyotstop_hdr</span><span class="p">[</span><span class="s1">&#39;PUPLDIAM&#39;</span><span class="p">],</span>
                             <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Lyot stop array size, incl padding.&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Association of Universities for Research in Astronomy
      <span class="lastupdated">
        Last updated on 20 Nov 2019.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>