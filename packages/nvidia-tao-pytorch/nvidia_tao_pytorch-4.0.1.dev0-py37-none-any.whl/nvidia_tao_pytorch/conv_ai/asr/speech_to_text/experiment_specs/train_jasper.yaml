# Copyright (c) 2020, NVIDIA CORPORATION. All rights reserved.
# TLT spec file for training the Jasper model for ASR using the Mozilla Common Voice English dataset.

trainer:
  max_epochs: 300

tlt_checkpoint_interval: 1

model:
  preprocessor:
    _target_: nemo.collections.asr.modules.AudioToMelSpectrogramPreprocessor
    normalize: per_feature
    window_size: 0.02
    sample_rate: 16000
    window_stride: 0.01
    window: hann
    features: 64
    n_fft: 512
    frame_splicing: 1
    dither: 1.0e-05
    stft_conv: false

  spec_augment:
    _target_: nemo.collections.asr.modules.SpectrogramAugmentation
    rect_freq: 50
    rect_masks: 5
    rect_time: 120

  encoder:
    _target_: nemo.collections.asr.modules.ConvASREncoder
    feat_in: 64
    activation: relu
    conv_mask: true

    jasper:
      - dilation: [1]
        dropout: 0.2
        filters: 256
        kernel: [11]
        repeat: 1
        residual: false
        stride: [2]

      - dilation: [1]
        dropout: 0.2
        filters: 256
        kernel: [11]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [1]
        dropout: 0.2
        filters: 256
        kernel: [11]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [1]
        dropout: 0.2
        filters: 384
        kernel: [13]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [1]
        dropout: 0.2
        filters: 384
        kernel: [13]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [1]
        dropout: 0.2
        filters: 512
        kernel: [17]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [1]
        dropout: 0.2
        filters: 512
        kernel: [17]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [1]
        dropout: 0.3
        filters: 640
        kernel: [21]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [1]
        dropout: 0.3
        filters: 640
        kernel: [21]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [1]
        dropout: 0.3
        filters: 768
        kernel: [25]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [1]
        dropout: 0.3
        filters: 768
        kernel: [25]
        repeat: 5
        residual: true
        residual_dense: true
        stride: [1]

      - dilation: [2]
        dropout: 0.4
        filters: 896
        kernel: [29]
        repeat: 1
        residual: false
        stride: [1]

      - dilation: [1]
        dropout: 0.4
        filters: 1024
        kernel: [1]
        repeat: 1
        residual: false
        stride: [1]

  decoder:
    _target_: nemo.collections.asr.modules.ConvASRDecoder
    feat_in: 1024
    num_classes: 28
    vocabulary: [" ", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m",
                 "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "'"]

training_ds:
  manifest_filepath: ???
  sample_rate: 16000
  labels: [" ", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m",
           "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "'"]
  batch_size: 32
  trim_silence: true
  max_duration: 16.7
  shuffle: true
  is_tarred: false
  tarred_audio_filepaths: null

validation_ds:
  manifest_filepath: ???
  sample_rate: 16000
  labels: [" ", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m",
           "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "'"]
  batch_size: 32
  shuffle: false

optim:
  name: novograd
  lr: 0.01
  betas: [0.8, 0.5]
  weight_decay: 0.001

  sched:
    name: CosineAnnealing
    warmup_steps: null
    warmup_ratio: null
    min_lr: 0.0
    last_epoch: -1

