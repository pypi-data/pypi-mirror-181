{% extends 'template_content/template_content_base.html' %}
{% load i18n imagekit static localcosmos_tags %}

{% block extra_style %}
	<link href="{% static 'template_content/template_content.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
	<div class="container-fluid mt-3">
		<div class="row">
			<div class="col-12">
				<h3>
					{{ localized_template_content.draft_title }} <img src="{% static 'localcosmos_server/images/countries/' %}{{ app.primary_language }}.gif" />
				</h3>

				{% if saved %}
					<div class="row">
						<div class="col-12">
							<div class="alert alert-success">
								{% trans 'Successfully saved your content.' %}
							</div>
						</div>
					</div>
				{% endif %}

			</div>
		</div>

		<div class="row">
			<div class="col-12 col-md-6">
			
				<div class="row">
					<div class="col-12">
					
						<div class="card">
							<div class="card-body">
								{% render_taxonomic_restriction app localized_template_content.template_content %}
							</div>
						</div>
					</div>
				</div>
				
				<hr>
				
				<h4>{% trans 'Components' %}</h4>
				<form id="contentform" action="{% url 'manage_localized_template_content' app.uid localized_template_content.id %}" method="POST">{% csrf_token %}

					{% for field in form %}

						{% if field.field.content_definition.type == 'multi-image' %}
		
							{% if field.field.is_first %}
								<div class="row field-label">
									<div class="col-12">
										{{ field.label }}
									</div>
								</div>
								<div id="{{ field.field.content_key }}-container" class="row">
							{% endif %}

							{% include 'template_content/widgets/filecontent_field.html' %}

							{% if field.field.is_last %}
								</div>
								<div class="row">
									<div class="col-12 text-center"><br>
										<button type="button" class="btn btn-outline-secondary add-content-button" data-target="{{ field.field.content_key }}-container">{% blocktrans with name=field.label %}add {{ name }}{% endblocktrans %}</button>
									</div>
								</div>
							{% endif %}
		
						{% elif field.field.content_definition.type == 'image' %}
								
							{% if field.is_hidden %}
							{% else %}
								<div class="row field-label">
									<div class="col-12">
										{{ field.label }}
									</div>
								</div>
							{% endif %}
							<div id="{{ field.field.content_key }}-container" class="row">
								{% include 'template_content/widgets/filecontent_field.html' %}
							</div>

						{% else %}
							{% include 'template_content/widgets/textcontent_field.html' %}
						{% endif %}				

					{% endfor %}

					<hr>
					<p>
						<button type="submit" class="btn btn-outline-primary">
							{% trans 'save content' %}
						</button>
					</p>
				</form>
			</div>
			<div class="col-12 col-md-6">
				<h4>{% trans 'Preview' %} <small><a href="{{ preview_url }}" target="_blank">{% trans 'Show in separate window' %}</a></small></h4>
				<object id="contentPreview" type="text/html" data="{{ preview_url }}"></object>
			</div>
		</div>
	</div>
	<input id="content_image_current_edit" type="hidden" />
{% endblock %}
{% block extra_script %}
	{% include 'template_content/ajax/manage_template_content_extra_scripts.html' %}

	<script>

		$(".add-content-button").on("click", function(ev){
			ev.preventDefault();
			var target =  $(this).attr("data-target");
			cms_add_element("#" + target);
		});


		function reloadPreview(){
			$("#contentPreview").attr("data", "{{ preview_url }}");
		}

		var current_edit = document.getElementById("content_image_current_edit");

		$(".content-image-button").on("click", function(event){
			let preview_id = event.currentTarget.getAttribute("data-container-id");
			current_edit.value = preview_id;
		});

	</script>
{% endblock %}
