# Based on the template from https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Python.gitlab-ci.yml

stages:
  - build
  - publish

# Official language image. Look for the different tagged releases at:
# https://hub.docker.com/r/library/python/tags/
image: python:3.11.1

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  TWINE_USERNAME: __token__
  TWINE_PASSWORD: $PYPI_API_TOKEN

build-package:
  stage: build

  cache:
    paths:
      - .cache/pip
      - venv/

  before_script:
    # install mono, see https://linuxize.com/post/how-to-install-mono-on-debian-10/#:~:text=%20Installing%20Mono%20on%20Debian%23%20%201%20Start,list%3A%0Asudo%20sh%20-c%20%27echo%20%22deb%20https%3A%2F%2Fdownload.mono-project.%20More%20
    - apt-get update
    - apt-get install -y dirmngr gnupg apt-transport-https ca-certificates
    - apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
    - sh -c 'echo "deb https://download.mono-project.com/repo/debian stable-buster main" > /etc/apt/sources.list.d/mono-official-stable.list'
    - apt-get update
    - apt install -y mono-complete
    - mono --version # For debugging

    - python --version # For debugging
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate

  script:
    # install the package itself including all requirements
    - python -m pip install .
    - pip list

    # test if importing the package works correctly
    #- export AML_ENGINE_DOTNET_VERSION="net6.0"
    #- export SYSTEM_IO_PACKAGING_DOTNET_VERSION="net6.0"
    # - python ./tests/test_import.py

    # create the source distribution to upload to PyPI
    - pip install build
    - python -m build --sdist
    #- pip install --no-deps --force-reinstall amlengine --no-index --find-links ./dist

  artifacts:
    paths:
      # - dist/*.whl
      - dist/*.tar.gz

upload-package-to-pypi:
  stage: publish
  script:
    - pip install twine
    - twine upload dist/*
  only:
    refs:
      - master
