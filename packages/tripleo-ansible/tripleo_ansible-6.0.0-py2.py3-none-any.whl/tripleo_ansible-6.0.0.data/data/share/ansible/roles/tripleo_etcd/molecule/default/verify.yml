---
# Copyright 2022 Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Check etcd.yml parameters
      lineinfile:
        name: /var/lib/config-data/ansible-generated/etcd/etc/etcd/etcd.yml
        regexp: "^\\s+{{ item.var }}"
        line: "{{ item.var }}: {{ item.value }}"
      loop:
        - {var: enable-pprof, value: 'True'}
        - {var: enable-grpc-gateway, value: 'True'}
        - {var: listen-client-urls, value: '"http://192.2.0.0:2379"'}
        - {var: name, value: '"node1"'}
        - {var: initial-cluster, value: '"node1=http://node1:2380,node2=http://node2:2380"'}
      register: etcd_yaml_result

    - name: Check etcd.conf parameters
      lineinfile:
        name: /var/lib/config-data/ansible-generated/etcd/etc/etcd/etcd.conf
        regexp: "^\\s+{{ item.var }}"
        line: "{{ item.var }}={{ item.value }}"
      loop:
        - {var: ETCD_LOGGER, value: '"zap"'}
        - {var: ETCD_DISCOVERY_FAILBACK, value: '"proxy"'}
        - {var: ETCD_LISTEN_PEER_URLS, value: '"http://192.2.0.0:2380"'}
        - {var: ETCD_NAME, value: '"node1"'}
        - {var: ETCD_INITIAL_CLUSTER, value: '"node1=http://node1:2380,node2=http://node2:2380"'}
      register: etcd_conf_result

    - name: Fail if etcd.yml parameters are not correct
      debug:
        msg: "/var/lib/config-data/ansible-generated/etcd/etc/etcd/etcd.yml settings are not correct."
      when:
        - etcd_yaml_result.changed
      failed_when:
        - true

    - name: Fail if etcd.conf parameters are not correct
      debug:
        msg: "/var/lib/config-data/ansible-generated/etcd/etc/etcd/etcd.conf settings are not correct."
      when:
        - etcd_conf_result.changed
      failed_when:
        - true
