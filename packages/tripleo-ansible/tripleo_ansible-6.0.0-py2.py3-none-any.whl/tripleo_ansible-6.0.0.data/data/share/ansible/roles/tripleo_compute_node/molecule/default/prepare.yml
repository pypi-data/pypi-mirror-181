---
# Copyright 2022 Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.


- name: Prepare
  hosts: tripleo_compute_node
  tasks:
    - name: test_deps
      include_role:
        name: test_deps
      vars:
        test_deps_setup_tripleo: true
        test_deps_tripleo_packages: []
    - name: env_data
      include_role:
        name: env_data

    # The openvswitch kernel module needs to be loaded on the host, since
    # tripleo_bootstrap assumes it can start the service.
    - name: install and modprobe openvswitch
      shell: |
        sudo dnf -y install openvswitch
        sudo modprobe openvswitch
      delegate_to: localhost
      run_once: true

    - name: Mock items when not running podman as root
      when: ansible_user_id != 0
      block:

        - name: Install packages that would otherwise be installed or needing to be mocked
          package:
            name:
              - cronie
              - rsyslog
              - procps-ng
              - systemd-udev
            state: present

        - name: Mock systemd-modules-load.service service
          shell: |
            sed -i 's/ExecStart=.*/ExecStart=\/bin\/true/' /lib/systemd/system/systemd-modules-load.service
            systemctl daemon-reload

        - name: Mock sysctl
          shell: |
            cat >/usr/local/sbin/sysctl<<EOF
            #!/bin/bash
            /usr/sbin/sysctl.save \$@
            exit 0
            EOF

            chmod +x /usr/local/sbin/sysctl
            if [ ! -f /usr/sbin/sysctl.save ]; then
              mv /usr/sbin/sysctl /usr/sbin/sysctl.save
            fi
            ln -f -s /usr/local/sbin/sysctl /usr/sbin/sysctl

        - name: Mock chrony
          shell: |
            dnf -y install chrony
            cat >/etc/sysconfig/chronyd<<EOF
            # Command-line options for chronyd
            OPTIONS="-F 2 -x"
            EOF

            cat >/usr/local/bin/chronyc<<EOF
            #!/bin/bash
            /usr/bin/chronyc.save \$@
            exit 0
            EOF
            chmod +x /usr/local/bin/chronyc

            if [ ! -f /usr/bin/chronyc.save ]; then
              mv /usr/bin/chronyc /usr/bin/chronyc.save
            fi
            ln -s -f /usr/local/bin/chronyc /usr/bin/chronyc
