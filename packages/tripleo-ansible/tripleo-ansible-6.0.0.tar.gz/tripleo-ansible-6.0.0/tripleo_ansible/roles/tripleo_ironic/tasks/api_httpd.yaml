---
- name: Ensure needed params are set
  fail:
    msg: "{{ item.k }} must be set to an actual value"
  when: item.v == None
  loop:
    - k: "tripleo_ironic_api_httpd_config_httpd_conf"
      v: "{{ tripleo_ironic_api_httpd_config_httpd_conf }}"
    - k: "tripleo_ironic_api_httpd_config_prefork_serverlimit"
      v: "{{ tripleo_ironic_api_httpd_config_prefork_serverlimit }}"
    - k: "tripleo_ironic_api_httpd_config_prefork_maxrequestworkers"
      v: "{{ tripleo_ironic_api_httpd_config_prefork_maxrequestworkers }}"
    - k: "tripleo_ironic_api_httpd_config_mods"
      v: "{{ tripleo_ironic_api_httpd_config_mods }}"

- name: Create httpd config and vhost
  vars:
    tripleo_httpd_config_httpd_conf: "{{ tripleo_ironic_api_httpd_config_httpd_conf }}"
    tripleo_httpd_config_prefork_serverlimit: "{{ tripleo_ironic_api_httpd_config_prefork_serverlimit }}"
    tripleo_httpd_config_prefork_maxrequestworkers: "{{ tripleo_ironic_api_httpd_config_prefork_maxrequestworkers }}"
    tripleo_httpd_config_mods: "{{ tripleo_ironic_api_httpd_config_mods }}"
    tripleo_httpd_vhost_ssl_ca: "{{ tripleo_ironic_api_httpd_vhost_ssl_ca }}"
    # Fixed params
    tripleo_httpd_vhost_user: 'ironic'
    tripleo_httpd_vhost_service_name: 'ironic_api'
    tripleo_httpd_vhost_group: "{{ tripleo_httpd_vhost_user }}"
    tripleo_httpd_vhost_access_log_format: 'forwarded'
    tripleo_httpd_vhost_access_log_name: 'ironic_wsgi'
    tripleo_httpd_vhost_document_root: '/var/www/cgi-bin/ironic'
    tripleo_httpd_vhost_wsgi_process_group: "{{ tripleo_httpd_vhost_user }}"
    tripleo_httpd_vhost_wsgi_daemon_process:
      ironic:
        'display-name': 'ironic_wsgi'
        group: "{{ tripleo_httpd_vhost_user }}"
        processes: 6
        threads: 15
        user: "{{ tripleo_httpd_vhost_user }}"
    tripleo_httpd_vhost_wsgi: true
    tripleo_httpd_vhost_wsgi_script_alias:
      '/': '/var/www/cgi-bin/ironic/app'
  import_role:
    name: tripleo_httpd_vhost
