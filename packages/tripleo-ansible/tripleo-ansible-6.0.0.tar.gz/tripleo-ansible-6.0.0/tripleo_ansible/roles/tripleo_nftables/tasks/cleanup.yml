---
- name: Execute nftables cleaning tasks as root
  become: true
  block:
    - name: Empty ruleset
      ansible.builtin.command: nft flush ruleset

    - name: Remove generated files
      ansible.builtin.file:
        path: "/etc/nftables/{{ item }}"
        state: absent
      loop:
        - iptables.nft
        - tripleo-chains.nft
        - tripleo-flushes.nft
        - tripleo-jumps.nft
        - tripleo-rules.nft
        - tripleo-update-jumps.nft

    - name: Clean sysconfig content
      ansible.builtin.blockinfile:
        path: /etc/sysconfig/nftables.conf
        state: absent
        backup: false
        block: |
          include "/etc/nftables/iptables.nft"
          include "/etc/nftables/tripleo-chains.nft"
          include "/etc/nftables/tripleo-rules.nft"
          include "/etc/nftables/tripleo-jumps.nft"

    - name: Remove snippets directory
      ansible.builtin.file:
        path: "{{ tripleo_nftables_src }}"
        state: absent
